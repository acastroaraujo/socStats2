---
title: "Week 6"
callout-appearance: simple
callout-icon: false
editor_options: 
  chunk_output_type: console
---

```{r}
#| message: false

library(tidyverse)
library(broom)

theme_set(theme_linedraw(base_family = "Avenir Next Condensed"))

```

## Regression

_Note. There where two exercises here about simulation and omitted variable bias which you can now find in the solutions. It's a story about how I used simulations to realize I was being misled by information contained in a famous textbook._

## Balance and Overlap

**Balance**

The sort of bias that we get from confounding can be interpreted more precisely as **imbalance** in the potential outcomes across treatment groups. This is the sort of imbalance is unlikely with *randomization*, but it’s almost guaranteed in observational studies.

In other words, imbalance occurs if the distributions of confounders differ for the treatment and control groups.

**Overlap**

@fig-overlap shows what lack of complete overlap (with respect to $x$) might look like:

```{r}
#| echo: false
#| label: fig-overlap
#| layout-ncol: 3
#| fig-height: 2
#| fig-width: 2.5
#| fig-cap: "Lack of complete overlap in distributions across treatment and control groups. Dashed lines indicate distributions for the control group; solid lines indicate distributions for the treatment group."
#| fig-subcap: 
#|   - "Two distributions with no overlap"
#|   - "Two distributions with partial overlap"
#|   - "The _range_ of one distribution is a subset of the range of the other."

ggplot() + 
  xlim(-4, 10) + 
  geom_function(fun = \(x) dnorm(x, -1, 1), linetype = "dashed") +
  geom_function(fun = \(x) dnorm(x, 7, 1)) + 
  theme_bw(base_family = "Avenir Next Condensed", base_line_size = 0) + 
  theme(axis.text = element_blank()) + 
  labs(x = "X", y = NULL, title = "No overlap")

ggplot() + 
  xlim(-4, 10) + 
  geom_function(fun = \(x) dnorm(x, 1, 1), linetype = "dashed") +
  geom_function(fun = \(x) dnorm(x, 4, 1)) + 
  theme_bw(base_family = "Avenir Next Condensed", base_line_size = 0) + 
  theme(axis.text = element_blank()) + 
  labs(x = "X", y = NULL, title = "Partial overlap")

ggplot() + 
  xlim(-4, 10) + 
  geom_function(fun = \(x) dnorm(x, 2, 3), linetype = "dashed") +
  geom_function(fun = \(x) dnorm(x, 7, 1)) + 
  theme_bw(base_family = "Avenir Next Condensed", base_line_size = 0) + 
  theme(axis.text = element_blank()) + 
  labs(x = "X", y = NULL, title = "Partial overlap")
```

Lack of complete overlap or "common support" creates problems because in this setting we have treatment or control observations for which we have *no empirical counterfactuals*. Thus, knowledge about treatment effects is inherently limited in regions of non-overlap. Any causal inference in @fig-overlap-1 would rely on modeling assumptions instead of having direct support from the data. In @fig-overlap-3 causal inference is possible for the full treatment group but only for a subset of the control group.

*Note. This is the exact same thing we talked about when thinking about the potential outcomes for a cervical cancer vaccine in a population for men and women.*

### Exercise

**Looking for imbalance.**

Load the `cattaneo2.dta` data that Steve showed us in class.

```{r}
d <- haven::read_dta("data/cattaneo2.dta")

d <- d |>  
  haven::zap_labels() |>             
  select(bweight, lbweight, mbsmoke, mmarried, mage, medu, fbaby, alcohol, mrace, nprenatal)

glimpse(d)
```

We can start checking for imbalance for several covariates by examining their absolute standardized difference in means—i.e., a **balance plot**. I've included a graph that shows the *absolute standardized difference in means values* for a set of confounding covariates that might predict both `mbsmoke` and birth weight.

![](images/imbalance_plot_example.png){fig-align="center" width="100%"}

::: callout-note
You're job is to reproduce something close to this figure.

What do you think are the most important covariates you need to adjust for in terms of the potential biases in the treatment effect?
:::

::: callout-tip
I used `geom_segment()`, but you can just use `geom_point()`.

An open question is exactly *which* "standard deviation" to use. I used the standard deviations of the treated group, but you are not required to use that one. This means that your final plot doesn't have to reproduce
:::

## Matching

This question is copied from NHK's exercises. To answer this question you need to read sections 14.1 and 14.2 of [*The Effect*](https://theeffectbook.net/)*.*

### Exercise

> You want to know whether practicing cursive improves your penmanship (on a 1-10 scale). You find that, among people who don’t practice cursive, average penmanship is 5, 10 people are left-handed, 2 are ambidextrous, and 88 are right-handed. Among people who do practice cursive, 6 are left-handed with average penmanship 7, 4 are ambidextrous with average penmanship 4, and 90 are right-handed with average penmanship 6.
>
> a.  You want to create a set of weights that will *make the treated group match the control group on handedness*. Follow the process in [section 14.2](https://theeffectbook.net/ch-Matching.html#weighted-averages), paying attention to *why* certain numbers are going in certain positions. What weights will be given to the left, ambidextrous, and right-handed people *in the control group*?
>
> b.  What weights will be given to the left, ambidextrous, and right-handed people *in the treated group*?
>
> c.  Use the weights from part b to calculate the *proportion of left-handed people in the treated group*, as well as the proportion of ambidextrous people and the proportion of right-handed people. If you don’t get 10%, 2%, and 88% (or very close with some rounding error), your weights are wrong, try again.
>
> d.  What is the weighted average penmanship score in the treated group?
>
> e.  What is the effect of practicing cursive that we would estimate using this data?
