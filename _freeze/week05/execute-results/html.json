{
  "hash": "e48bac815e1530f26f8bda6da4080a39",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Week 5\"\ncallout-appearance: simple\ncallout-icon: false\neditor_options: \n  chunk_output_type: console\n---\n\n\n::: {style=\"text-align: right;\"}\n*You don't know what you've got until it's gone.*\n:::\n\nHi everyone, this is `marginaleffects` appreciation week. I will be asking you to re-do some of the things we did with Steve *without* using this package and then compare the results.\n\nYou will need to run the following chunk of code before running anything else.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Set up\"}\nlibrary(tidyverse)\nlibrary(gssr)\nlibrary(marginaleffects)\nlibrary(broom)\n\ngss2022 <- gss_get_yr(2022)\n```\n:::\n\n\n*Note. We will be using data from the GSS instead of simulated \"toy data.\" Don't give too much thought to the \"validity\" of these estimates; think about them as applying \"toy DAGs\" to real data. I only care that you understand the mechanics average treatment effects using regression.*\n\n*If you are done quickly, I recommend you skim this website:*\n\n<https://marginaleffects.com/>\n\n## Instructions\n\n::: callout-note\nThis homework has three sections.\n\nEach exercise has two `marginaleffects` outputs: (1) the ATE estimate and (2) the ATT/ATU estimates.\n\nYou will have to reproduce these estimates *without* using `marginaleffects`. There are a couple of ways to do this, but you will probably end up using the `predict()` function (from base R), or the `augment()` function (from the `broom` package).\n:::\n\nBoth functions have an argument called `newdata`, which you can use doing something similar to this toy example:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nols <- lm(mpg ~ disp + am, data = mtcars)\n\nnew_am0 <- mtcars |> \n  mutate(am = 0)\n\nnew_am1 <- mtcars |> \n  mutate(am = 1)\n\np0 <- predict(ols, newdata = new_am0) ## predictions for am == 0\np1 <- predict(ols, newdata = new_am1) ## predictions for am == 1\n```\n:::\n\n\n::: callout-tip\n**Bonus**\n\nThe `avg_slopes()` function has an arguments called `hypothesis` which lets you estimate a standard error for the difference between the ATT and the ATU (among other things). This shows up in Steve's code for this week.\n\nIf you are done early, I suggest you try and calculate one of these standard errors *without* `avg_slopes` (e.g., using a bootstrap).\n:::\n\n## Linear Regression\n\n*We will use this data.*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- gss2022 |> \n  select(tvhours, degree, madeg, padeg) |> \n  mutate(pardeg = pmax(madeg, padeg, na.rm = TRUE),\n         college = if_else(degree >= 3, 1L, 0L),\n         parcol = if_else(pardeg >= 3, 1L, 0L)) |>\n  select(tvhours, college, parcol) |> \n  drop_na()\n```\n:::\n\n\n### Exercise\n\n**Additive link function, no interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod1 <- lm(tvhours ~ college + parcol, data = d)\n\n# ATE estimate\navg_slopes(mod1, variables = \"college\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term  contrast estimate std.error statistic p.value s.value conf.low conf.high\n  <chr> <chr>       <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>     <dbl>\n1 coll… 1 - 0      -0.796     0.151     -5.27 1.35e-7    22.8    -1.09    -0.500\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ATT/ATU estimate\navg_slopes(\n  model = mod1, \n  variables = \"college\",\n  by = \"college\" # separately by treatment group\n) |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term    contrast college estimate std.error statistic p.value s.value conf.low\n  <chr>   <chr>      <int>    <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>\n1 college mean(1)…       0   -0.796     0.151     -5.27 1.35e-7    22.8    -1.09\n2 college mean(1)…       1   -0.796     0.151     -5.27 1.35e-7    22.8    -1.09\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n### Exercise\n\n**Additive link function, with interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod2 <- lm(tvhours ~ college * parcol, data = d)\n\n# ATE estimate\navg_slopes(mod2, variables = \"college\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term  contrast estimate std.error statistic p.value s.value conf.low conf.high\n  <chr> <chr>       <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>     <dbl>\n1 coll… 1 - 0      -0.803     0.152     -5.29 1.20e-7    23.0    -1.10    -0.506\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ATT/ATU estimate\navg_slopes(\n  model = mod2, \n  variables = \"college\",\n  by = \"college\" # separately by treatment group\n) |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term    contrast college estimate std.error statistic p.value s.value conf.low\n  <chr>   <chr>      <int>    <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>\n1 college mean(1)…       0   -0.821     0.160     -5.14 2.70e-7    21.8    -1.13\n2 college mean(1)…       1   -0.772     0.159     -4.87 1.13e-6    19.8    -1.08\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n## Poisson Regression\n\n*We will use this data.*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- gss2022 |>\n  filter(wrkstat == 1) |> # full time workers\n  select(realrinc, degree, madeg, padeg, sex, age) |> \n  mutate(pardeg = pmax(madeg, padeg, na.rm = TRUE),\n         college = if_else(degree >= 3, 1L, 0L),\n         parcol = if_else(pardeg >= 3, 1L, 0L),\n         female = if_else(sex == 2, 1L, 0L),\n         realrinc = floor(realrinc)) |>             # integer\n  select(realrinc, college, parcol, female, age) |> \n  drop_na()\n```\n:::\n\n\n### Exercise\n\n**Using the log-counts, no interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nqp1 <- glm(realrinc ~ college + (parcol + female + age + I(age^2)), \n           data = d,\n           family = \"quasipoisson\")\n\navg_slopes(qp1,\n           variables = \"college\",\n           type = \"link\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term    contrast estimate std.error statistic  p.value s.value conf.low\n  <chr>   <chr>       <dbl>     <dbl>     <dbl>    <dbl>   <dbl>    <dbl>\n1 college 1 - 0       0.599    0.0510      11.7 7.45e-32    103.    0.499\n# ℹ 1 more variable: conf.high <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(qp1,\n           variables = \"college\",\n           type = \"link\",\n           by = \"college\") |> # separately by treatment group\n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term   contrast college estimate std.error statistic  p.value s.value conf.low\n  <chr>  <chr>      <int>    <dbl>     <dbl>     <dbl>    <dbl>   <dbl>    <dbl>\n1 colle… mean(1)…       0    0.599    0.0510      11.7 7.45e-32    103.    0.499\n2 colle… mean(1)…       1    0.599    0.0510      11.7 7.45e-32    103.    0.499\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n### Exercise\n\n**Non-linear response, no interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(qp1,\n           variables = \"college\",\n           type = \"response\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term    contrast estimate std.error statistic  p.value s.value conf.low\n  <chr>   <chr>       <dbl>     <dbl>     <dbl>    <dbl>   <dbl>    <dbl>\n1 college 1 - 0      21237.     1831.      11.6 4.18e-31    101.   17649.\n# ℹ 1 more variable: conf.high <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(qp1,\n           variables = \"college\",\n           type = \"response\",\n           by = \"college\") |> # separately by treatment group\n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term   contrast college estimate std.error statistic  p.value s.value conf.low\n  <chr>  <chr>      <int>    <dbl>     <dbl>     <dbl>    <dbl>   <dbl>    <dbl>\n1 colle… mean(1)…       0   20636.     1861.      11.1 1.41e-28    92.5   16988.\n2 colle… mean(1)…       1   21977.     1816.      12.1 1.05e-33   110.    18417.\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\n### Exercise\n\n**Using the log-counts, with interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nqp2 <- glm(realrinc ~ college * (parcol + female + age + I(age^2)), \n           data = d,\n           family = \"quasipoisson\")\n\navg_slopes(qp2,\n           variables = \"college\",\n           type = \"link\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term    contrast estimate std.error statistic  p.value s.value conf.low\n  <chr>   <chr>       <dbl>     <dbl>     <dbl>    <dbl>   <dbl>    <dbl>\n1 college 1 - 0       0.580    0.0543      10.7 1.20e-26    86.1    0.474\n# ℹ 1 more variable: conf.high <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(qp2,\n           variables = \"college\",\n           type = \"link\",\n           by = \"college\") |> # separately by treatment group\n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term   contrast college estimate std.error statistic  p.value s.value conf.low\n  <chr>  <chr>      <int>    <dbl>     <dbl>     <dbl>    <dbl>   <dbl>    <dbl>\n1 colle… mean(1)…       0    0.567    0.0571      9.94 2.77e-23    74.9    0.455\n2 colle… mean(1)…       1    0.596    0.0600      9.94 2.87e-23    74.9    0.479\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n### Exercise\n\n**Non-linear response, with interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(qp2,\n           variables = \"college\",\n           type = \"response\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term    contrast estimate std.error statistic  p.value s.value conf.low\n  <chr>   <chr>       <dbl>     <dbl>     <dbl>    <dbl>   <dbl>    <dbl>\n1 college 1 - 0      21190.     1817.      11.7 1.99e-31    102.   17629.\n# ℹ 1 more variable: conf.high <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(qp2,\n           variables = \"college\",\n           type = \"response\",\n           by = \"college\") |> # separately by treatment group\n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term   contrast college estimate std.error statistic  p.value s.value conf.low\n  <chr>  <chr>      <int>    <dbl>     <dbl>     <dbl>    <dbl>   <dbl>    <dbl>\n1 colle… mean(1)…       0   20196.     1937.      10.4 1.90e-25    82.1   16400.\n2 colle… mean(1)…       1   22411.     1963.      11.4 3.51e-30    97.8   18563.\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n## Logistic Regression\n\n*We will use this data.*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nd <- gss2022 |>\n  select(abany, degree, madeg, padeg, sex, age) |> \n  mutate(pardeg = pmax(madeg, padeg, na.rm = TRUE),\n         college = if_else(degree >= 3, 1L, 0L),\n         parcol = if_else(pardeg >= 3, 1L, 0L),\n         female = if_else(sex == 2, 1L, 0L),\n         abany = if_else(abany == 1, 1L, 0L)) |>\n  select(abany, college, parcol, female, age) |> \n  drop_na()\n```\n:::\n\n\n### Exercise\n\n**Using log-odds, no interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlr1 <- glm(abany ~ college + (parcol + female + age + I(age^2)),\n          data = d,\n          family = binomial)\n\n# ATE estimate\navg_slopes(lr1,\n           variables = \"college\",\n           type = \"link\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term  contrast estimate std.error statistic p.value s.value conf.low conf.high\n  <chr> <chr>       <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>     <dbl>\n1 coll… 1 - 0       0.438     0.146      3.00 0.00273    8.52    0.151     0.724\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(lr1,\n           variables = \"college\",\n           by = \"college\",\n           type = \"link\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term    contrast college estimate std.error statistic p.value s.value conf.low\n  <chr>   <chr>      <int>    <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>\n1 college mean(1)…       0    0.438     0.146      3.00 0.00273    8.52    0.151\n2 college mean(1)…       1    0.438     0.146      3.00 0.00273    8.52    0.151\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n### Exercise\n\n**Using non-linear response (aka probabilities), no interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ATE estimate\navg_slopes(lr1,\n           variables = \"college\",\n           type = \"response\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term  contrast estimate std.error statistic p.value s.value conf.low conf.high\n  <chr> <chr>       <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>     <dbl>\n1 coll… 1 - 0       0.102    0.0337      3.02 0.00249    8.65   0.0359     0.168\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(lr1,\n           variables = \"college\",\n           by = \"college\",\n           type = \"response\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term    contrast college estimate std.error statistic p.value s.value conf.low\n  <chr>   <chr>      <int>    <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>\n1 college mean(1)…       0   0.104     0.0341      3.04 0.00235    8.73   0.0369\n2 college mean(1)…       1   0.0989    0.0330      2.99 0.00275    8.51   0.0342\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n### Exercise\n\n**Using log-odds, with interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlr2 <- glm(abany ~ college * (parcol + female + age + I(age^2)),\n          data = d,\n          family = binomial)\n\n# ATE estimate\navg_slopes(lr2,\n           variables = \"college\",\n           type = \"link\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term  contrast estimate std.error statistic p.value s.value conf.low conf.high\n  <chr> <chr>       <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>     <dbl>\n1 coll… 1 - 0       0.453     0.149      3.04 0.00239    8.71    0.161     0.745\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(lr2,\n           variables = \"college\",\n           by = \"college\",\n           type = \"link\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term    contrast college estimate std.error statistic p.value s.value conf.low\n  <chr>   <chr>      <int>    <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>\n1 college mean(1)…       0    0.450     0.159      2.83 0.00460    7.76    0.139\n2 college mean(1)…       1    0.458     0.161      2.85 0.00435    7.84    0.143\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n### Exercise\n\n**Using non-linear response (aka probabilities), with interactions**\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# ATE estimate\navg_slopes(lr2,\n           variables = \"college\",\n           type = \"response\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 × 9\n  term  contrast estimate std.error statistic p.value s.value conf.low conf.high\n  <chr> <chr>       <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>     <dbl>\n1 coll… 1 - 0       0.103    0.0338      3.05 0.00228    8.78   0.0369     0.169\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n\n\n::: {.cell}\n\n```{.r .cell-code}\navg_slopes(lr2,\n           variables = \"college\",\n           by = \"college\",\n           type = \"response\") |> \n  tidy()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 × 13\n  term    contrast college estimate std.error statistic p.value s.value conf.low\n  <chr>   <chr>      <int>    <dbl>     <dbl>     <dbl>   <dbl>   <dbl>    <dbl>\n1 college mean(1)…       0    0.104    0.0363      2.87 0.00407    7.94   0.0332\n2 college mean(1)…       1    0.101    0.0353      2.87 0.00415    7.91   0.0320\n# ℹ 4 more variables: conf.high <dbl>, predicted_lo <dbl>, predicted_hi <dbl>,\n#   predicted <dbl>\n```\n\n\n:::\n:::\n\n\nANSWER GOES HERE\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}